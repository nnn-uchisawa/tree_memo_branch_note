name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quick-check:
    name: ã‚¯ã‚¤ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Flutterã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: flutter pub get

      - name: .envãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
        run: |
          cat << EOF > .env
          # ãƒ€ãƒŸãƒ¼ã®Firebaseè¨­å®šï¼ˆãƒ“ãƒ«ãƒ‰æ¤œè¨¼ç”¨ï¼‰
          ANDROID_API_KEY=dummy_key
          ANDROID_APP_ID=dummy_app_id
          ANDROID_MESSAGING_SENDER_ID=dummy_sender_id
          ANDROID_PROJECT_ID=dummy_project_id
          ANDROID_STORAGE_BUCKET=dummy_bucket
          IOS_API_KEY=dummy_key
          IOS_APP_ID=dummy_app_id
          IOS_MESSAGING_SENDER_ID=dummy_sender_id
          IOS_PROJECT_ID=dummy_project_id
          IOS_STORAGE_BUCKET=dummy_bucket
          IOS_BUNDLE_ID=jp.nnn.tree.dev
          EOF

      - name: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: google-services.jsonã®ä½œæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
        run: |
          cat << 'EOF' > android/app/google-services.json
          {
            "project_info": {
              "project_number": "123456789",
              "project_id": "dummy-project",
              "storage_bucket": "dummy-project.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789:android:dummy",
                  "android_client_info": {
                    "package_name": "com.nnn.tree"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "dummy-api-key"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF

      - name: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        id: format
        run: |
          dart format --set-exit-if-changed . > format_output.txt 2>&1 || echo "FORMAT_FAILED=true" >> $GITHUB_OUTPUT
          cat format_output.txt

      - name: é™çš„è§£æ
        id: analyze
        run: |
          flutter analyze > analyze_output.txt 2>&1 || echo "ANALYZE_FAILED=true" >> $GITHUB_OUTPUT
          cat analyze_output.txt

      - name: åŸºæœ¬ãƒ†ã‚¹ãƒˆ
        id: test
        run: |
          flutter test --no-coverage > test_output.txt 2>&1 || echo "TEST_FAILED=true" >> $GITHUB_OUTPUT
          cat test_output.txt

      - name: ãƒã‚§ãƒƒã‚¯çµæœã®ã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          echo "## ğŸ” PR ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.format.outputs.FORMAT_FAILED }}" == "true" ]; then
            echo "- âŒ **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.analyze.outputs.ANALYZE_FAILED }}" == "true" ]; then
            echo "- âŒ **é™çš„è§£æ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **é™çš„è§£æ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.test.outputs.TEST_FAILED }}" == "true" ]; then
            echo "- âŒ **ãƒ†ã‚¹ãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **ãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã®çµ‚äº†
        if: steps.format.outputs.FORMAT_FAILED == 'true' || steps.analyze.outputs.ANALYZE_FAILED == 'true' || steps.test.outputs.TEST_FAILED == 'true'
        run: exit 1

