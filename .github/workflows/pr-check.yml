name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quick-check:
    name: ã‚¯ã‚¤ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Flutterã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: flutter pub get

      - name: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        id: format
        run: |
          dart format --set-exit-if-changed . > format_output.txt 2>&1 || echo "FORMAT_FAILED=true" >> $GITHUB_OUTPUT
          cat format_output.txt

      - name: é™çš„è§£æ
        id: analyze
        run: |
          flutter analyze > analyze_output.txt 2>&1 || echo "ANALYZE_FAILED=true" >> $GITHUB_OUTPUT
          cat analyze_output.txt

      - name: åŸºæœ¬ãƒ†ã‚¹ãƒˆ
        id: test
        run: |
          flutter test --no-coverage > test_output.txt 2>&1 || echo "TEST_FAILED=true" >> $GITHUB_OUTPUT
          cat test_output.txt

      - name: ãƒã‚§ãƒƒã‚¯çµæœã®ã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          echo "## ğŸ” PR ãƒã‚§ãƒƒã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.format.outputs.FORMAT_FAILED }}" == "true" ]; then
            echo "- âŒ **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.analyze.outputs.ANALYZE_FAILED }}" == "true" ]; then
            echo "- âŒ **é™çš„è§£æ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **é™çš„è§£æ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.test.outputs.TEST_FAILED }}" == "true" ]; then
            echo "- âŒ **ãƒ†ã‚¹ãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… **ãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã®çµ‚äº†
        if: steps.format.outputs.FORMAT_FAILED == 'true' || steps.analyze.outputs.ANALYZE_FAILED == 'true' || steps.test.outputs.TEST_FAILED == 'true'
        run: exit 1

